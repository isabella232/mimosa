all:
	@echo "âœ… Nothing to be done for docker (`date '+%H:%M:%S'`)"

PHONY+= test
test:
	@echo "âœ… Nothing to be done for docker (`date '+%H:%M:%S'`)"

PHONY+= tidy
tidy:
	@echo "âœ… Nothing to be done for docker (`date '+%H:%M:%S'`)"

PHONY+= format
format:
	@echo "âœ… Nothing to be done for docker (`date '+%H:%M:%S'`)"

PHONY+= lint
lint:
	@echo "âœ… Nothing to be done for docker (`date '+%H:%M:%S'`)"

PHONY+= cloudbuild
cloudbuild:
	@echo "ðŸ”˜ Creating 'build' container (`date '+%H:%M:%S'`)"
	@docker build build -t gcr.io/${MIMOSA_GCP_PROJECT}/cloudbuild
	@docker push gcr.io/${MIMOSA_GCP_PROJECT}/cloudbuild
	@echo "âœ… Created 'build' container (`date '+%H:%M:%S'`)"

PHONY+= deploy
deploy: deploy-runner

PHONY+= enable-cloud-run-api
enable-cloud-run-api:
ifndef MIMOSA_GCP_PROJECT
	$(error MIMOSA_GCP_PROJECT must be defined)
endif
	@gcloud services enable --project ${MIMOSA_GCP_PROJECT} containerregistry.googleapis.com

PHONY+= deploy-runner
deploy-runner: enable-cloud-run-api
ifndef MIMOSA_GCP_PROJECT
	$(error MIMOSA_GCP_PROJECT must be defined)
endif
	${call build-container,runner}

PHONY+= deploy-reusabolt-facts
deploy-reusabolt-facts: enable-cloud-run-api
ifndef MIMOSA_GCP_PROJECT
	$(error MIMOSA_GCP_PROJECT must be defined)
endif
	${call build-container,reusabolt-facts}

define build-container
	@echo "ðŸ”˜ Deploy container ${1} (`date '+%H:%M:%S'`)"
	@docker build ${1} -t gcr.io/${MIMOSA_GCP_PROJECT}/${1}
	@docker push gcr.io/${MIMOSA_GCP_PROJECT}/${1}
	@gcloud beta run deploy --image gcr.io/${MIMOSA_GCP_PROJECT}/${1} --platform managed --region europe-west1 --no-allow-unauthenticated ${1}
	@echo "âœ… Deployed container ${1} (`date '+%H:%M:%S'`)"
endef
